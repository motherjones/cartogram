/*! Cartograph - v0.1.0 - 2013-11-12
* https://github.com/motherjones/cartograph
* Copyright (c) 2013 Mother Jones Data Desk; Licensed MIT */
"use strict";function updateZoom(){var e=zoom.scale();layer.attr("transform","translate("+zoom.translate()+") "+"scale("+[e,e]+")")}function init(){var e=carto.features(topology,geometries),t=d3.geo.path().projection(proj);states=states.data(e).enter().append("path").attr("class","state").attr("id",function(e){return e.properties.Name}).attr("fill","#fafafa").attr("d",t),states.append("title"),parseHash()}function reset(){stat.text(""),body.classed("updating",!1);var e=carto.features(topology,geometries),t=d3.geo.path().projection(proj);states.data(e).transition().duration(750).ease("linear").attr("fill","#fafafa").attr("d",t),states.select("title").text(function(e){return e.properties.NAME})}function update(){var e=Date.now();body.classed("updating",!0);var t=field.key.replace("%d",year),a="function"==typeof field.format?field.format:d3.format(field.format||","),r=function(e){return+e.properties[t]},n=states.data().map(r).filter(function(e){return!isNaN(e)}).sort(d3.ascending),o=n[0],s=n[n.length-1],i=d3.scale.linear().range(colors).domain(0>o?[o,0,s]:[o,d3.mean(n),s]),l=d3.scale.linear().domain([o,s]).range([1,1e3]);carto.value(function(e){return l(r(e))});var d=carto(topology,geometries).features;states.data(d).select("title").text(function(e){return[e.properties.NAME,a(r(e))].join(": ")}),states.transition().duration(750).ease("linear").attr("fill",function(e){return i(r(e))}).attr("d",carto.path);var c=(Date.now()-e)/1e3;stat.text(["calculated in",c.toFixed(1),"seconds"].join(" ")),body.classed("updating",!1)}function parseHash(){var e=location.hash.substr(1).split("/"),t=e[0],a=parseInt(e[1]);field=fieldsById[t]||fields[0],console.log(a),console.log(years),year=years.indexOf(a)>-1?a:years[0],console.log(year),fieldSelect.property("selectedIndex",fields.indexOf(field)),"none"===field.id?(yearSelect.attr("disabled","disabled"),reset()):(field.years?(-1===field.years.indexOf(year)&&(year=field.years[0]),yearSelect.selectAll("option").attr("disabled",function(e){return-1===field.years.indexOf(e)?"disabled":null})):yearSelect.selectAll("option").attr("disabled",null),yearSelect.property("selectedIndex",years.indexOf(year)).attr("disabled",null),deferredUpdate(),location.replace("#"+[field.id,year].join("/")),hashish.attr("href",function(e){return e+location.hash}))}document.createElementNS||(document.getElementsByTagName("form")[0].style.display="none");var percent=function(){var e=d3.format(".2f");return function(t){return e(t)+"%"}}(),years=[1995,1996,1997,1998,1999,2e3,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010],fields=[{name:"UFO Sightings",id:"sightings",key:"sighting%d",years:years}],fieldsById=d3.nest().key(function(e){return e.id}).rollup(function(e){return e[0]}).map(fields),field=fields[0],year=years[0],colors=colorbrewer.RdYlBu[3].reverse().map(function(e){return d3.hsl(e)}),body=d3.select("body"),stat=d3.select("#status"),fieldSelect=d3.select("#field").on("change",function(){field=fields[this.selectedIndex],location.hash="#"+[field.id,year].join("/")});fieldSelect.selectAll("option").data(fields).enter().append("option").attr("value",function(e){return e.id}).text(function(e){return e.name});var yearSelect=d3.select("#year").on("change",function(){year=years[this.selectedIndex],location.hash="#"+field.id+"/"+year});yearSelect.selectAll("option").data(years).enter().append("option").attr("value",function(e){return e}).text(function(e){return e});var map=d3.select("#map"),zoom=d3.behavior.zoom().translate([-38,32]).scale(.94).scaleExtent([.5,10]).on("zoom",updateZoom),layer=map.append("g").attr("id","layer"),states=layer.append("g").attr("id","states").selectAll("path");updateZoom();var proj=d3.geo.albersUsa(),topology,geometries,rawData,dataById={},carto=d3.cartogram().projection(proj).properties(function(e){return dataById[e.id]}).value(function(e){return+e.properties[field]});window.onhashchange=function(){parseHash()};var segmentized="?segmentized"===location.search,url=["data",segmentized?"us-states-segmentized.topojson":"us-states.topojson"].join("/");d3.json(url,function(e){topology=e,geometries=topology.objects.states.geometries,d3.csv("data/ufo_by_state.csv",function(e){rawData=e,dataById=d3.nest().key(function(e){return e.Name}).rollup(function(e){return e[0]}).map(e),init()})});var deferredUpdate=function(){var e;return function(){return clearTimeout(e),stat.text("calculating..."),e=setTimeout(function(){update.apply(null,arguments)},10)}}(),hashish=d3.selectAll("a.hashish").datum(function(){return this.href});